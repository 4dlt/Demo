name: DevSecOps

on:
  pull_request:
    branches:
      - release
  workflow_dispatch:

jobs:
  trufflehog_secret_scan:
    runs-on: ubuntu-latest
    name: Secret Scan - TruffleHog

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run TruffleHog and format JSON output
      run: |
        mkdir -p reports/trufflehog
        docker run --rm -v "${{ github.workspace }}:/home" trufflesecurity/trufflehog filesystem --json /home > raw-trufflehog.json
        cat raw-trufflehog.json | docker run --rm -i ghcr.io/jqlang/jq:1.7.1 -s . > reports/trufflehog/trufflehog-secrets-report.json

    - name: Count total secrets found
      id: count
      run: |
        COUNT=$(jq 'length' reports/trufflehog/trufflehog-secrets-report.json)
        echo "found=$COUNT" >> $GITHUB_OUTPUT

    - name: Comment on PR with results
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        message: |
          üîê **TruffleHog Secret Scan Results**
          - Secrets found: **${{ steps.count.outputs.found }}**
          
          ${{ steps.count.outputs.found == '0' && '‚úÖ No secrets detected!' || '‚ö†Ô∏è Please review the report file `trufflehog-secrets-report.json` for details.' }}
      continue-on-error: true

    - name: Upload TruffleHog Report
      uses: actions/upload-artifact@v4
      with:
        name: trufflehog-secrets-report
        path: reports/trufflehog/trufflehog-secrets-report.json

  semgrep_sast_scan:
    runs-on: ubuntu-latest
    name: SAST Scan - Semgrep

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Semgrep Scan
      run: |
        mkdir -p reports/semgrep
        docker run --rm -v "${{ github.workspace }}:/src" semgrep/semgrep:latest semgrep --config auto --json -o /src/reports/semgrep/semgrep-sast-report.json
      continue-on-error: true

    - name: Upload Semgrep Report
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-sast-report
        path: reports/semgrep/semgrep-sast-report.json

  dependency_check_sca_scan:
    runs-on: ubuntu-latest
    name: SCA Scan - OWASP Dependency Check

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Dependency Check Scan
      run: |
        mkdir -p reports/dependency-check
        docker run --rm --user=root -v "${{ github.workspace }}:/src" owasp/dependency-check:9.0.0 \
          --scan /src \
          --format JSON \
          --format HTML \
          --out /src/reports/dependency-check \
          --prettyPrint
      continue-on-error: true

    - name: Upload Dependency Check Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-sca-report
        path: |
          reports/dependency-check/dependency-check-report.json
          reports/dependency-check/dependency-check-report.html

  trivy_image_scan:
    runs-on: ubuntu-latest
    name: Container Scan - Trivy

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Image Scan with Trivy
      run: |
        mkdir -p reports/trivy
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v "${{ github.workspace }}:/home" \
          aquasec/trivy:latest fs /home --format json -o /home/reports/trivy/trivy-image-report.json
      continue-on-error: true

    - name: Upload Trivy Scan Report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-scan-report
        path: reports/trivy/trivy-image-report.json

  checkov_iac_scan:
    runs-on: ubuntu-latest
    name: IaC Scan - Checkov

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Checkov Scan
      run: |
        mkdir -p reports/checkov
        docker run --rm \
          -v "${{ github.workspace }}:/tf" \
          --workdir /tf \
          bridgecrew/checkov:3.2.401 \
          --directory /tf \
          -o cli -o json \
          --output-file-path console,reports/checkov/checkov-iac-report.json \
          --skip-resources-without-violations --quiet --compact
      continue-on-error: true

    - name: Upload Checkov Report
      uses: actions/upload-artifact@v4
      with:
        name: checkov-iac-report
        path: reports/checkov/checkov-iac-report.json
